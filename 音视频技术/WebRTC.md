# WebRTC

## WebRTC三种类型（Mesh、MCU、SFU）的多方通信架构

- Mesh方案，即多个终端之间两两进行连接，形成一个网状结构。比如A、B、C三个终端进行多对多通信，当A想要共享媒体（比如音频、视频时），它需要分别向B和C发送数据。同样的道理，B想要共享媒体，就需要分别向A、C发送数据，以此类推。这种方案对各终端的带宽要求比较高。
- MCU（Multipoint Conferencing Unit）方案，该方案由一个服务器和多个终端组成一个星形结构。各终端将自己要共享的音视频发送给服务器，服务器端会将在同一个房间中的所有终端的音视频进行混合，最终生成一个混合后的音视频流再发送给各个终端，这样各终端就可以看到/听到其他终端的音视频了。实际上服务器端就是一个音视频混合器，这种方案服务器的压力会非常大。
- SFC（Selective Forwarding Unit）方案，该方案也是由一个服务器和多个终端组成，但与MCU不同的是，SFU不对音视频镜像混流，收到某个终端共享的音视频流后，直接将该音视频流转发给房间内的其他终端。它实际上就是一个音视频路由转发器。

## WebRTC音视频通信基本流程

1. 一方发起调用getUserMedia打开本地摄像头
2. 媒体协商（信令交换）
3. 建立通信

## 媒体协商

媒体协商主要指的是SDP交换，媒体协商的大致流程为：

1. 发起端创建Offer并调用setLocalDescription将其保存起来，通过信令服务器传送给接收端。
2. 接收端收到对等端的Offer信息后调用SetRemoteDescription方法将其保存起来，并创建Answer信息，同理也将Answer信息通过setLocalDescription保存，并通过信令服务器传送给发起端。
3. 发起端收到对等端的Answer信息后调用setRemoteDescription方法将其Answer保存起来。

### 1. 为什么需要媒体协商？

媒体协商的作用就是让双方找到共同支持的媒体能力，从而实现彼此之间的音视频通信。比如两个人想聊天，一个人只会讲中文，喜欢讨论前端；一个人只会讲英文，不呼唤前端技术；通过互换资料，发现这没法聊天。但如果出现另一个人会讲中文，喜欢研究代码和前端技术，跟第一个跟交换信息后，发现可以发起聊天。所以发起端与接收端进行通信之前需要进行媒体协商。

### 2. 媒体协商在做什么？

媒体协商就是在【交换 SDP】的过程。会话发起者通过创建一个Offer，经过信令服务器发送到接收方，接收方创建answer并返回给发送方，完成交换。

### 3. SDP是什么？

SDP（Session Description Protocol）指【会话描述协议】，是一种通用的协议，基于文本，其本身并不属于传输协议，需要依赖其他的传输协议（如RTP 交换媒体信息。

SDP主要用来描述多媒体会话，用途包括会话声明、会话邀请、会话初始化等。通俗来见，它可以表示各端的能力，记录有关于你音频编解码类型、编解码器相关的参数、传输协议等信息。

交换SDP时，通信的双方将收到的SDP和自己的SDP进行比较，取出他们之间的交集，这个交集就是协商的结果，也就是最终双方音视频通信时使用的音视频参数以及传输协议。

### 4. offer和answer是什么？

在双方要建立点对点通信时，发起端发送的SDP消息称为Offer，接收端发送的SDP消息称为Answer。所以Offer和Answer的本质就是存有SDP信息的对象，所以也会叫做SDP Offer和SDP Answer。

## ICE

当媒体协商完成后，WebRTC就开始建立网络连接，其过程称为ICE(Interactive Connectivity Establishment)交互式连接建立。

ICE不是一种协议，整合了STUN和TURN两种协议（用于NAT穿透）的框架。

ICE是在各端调用setLocalDescription()后就开始了，其操作过程如下：

1. 收集Candidate
2. 交换Candidate
3. 按优先级尝试连接

### 1. 什么是Candidate？

比如想用socket连接某台服务器，一定要知道这台服务器的一些基本信息，如服务器的IP地址、端口号以及使用的传输协议。只有知道了这些信息，才能与这台服务器建立连接。而Candidate正是WebRTC用来描述它可以连接的远端的基本信息，因此Candidate是至少包括IP地址、端口号、协议的一个信息集。

### 2. 收集Candidate

在WebRTC中又三种类型的【ICE候选者（Candidate）】

1. 【主机候选者】：表示网卡自己的IP地址及端口。通过设备网卡获取，优先级最高。在WebRTC底层首先会尝试本地局域网内建立连接。
2. 【反射候选者】：表示经过NAT之后的外网IP地址和端口，又ICE（STUN）服务器获取，根据服务器的返回情况，来综合判断并知道自身在公网中的地址。其优先级低于主机候选者，当WebRTC尝试本地连接不通时，会尝试通过反射候选者获得的IP地址和端口进行连接。
3. 【中继候选者】：表示的是中继（TURN）服务器的转发IP地址和端口，由ICE中继服务器提供。优先级最低，前两个都不行则会按照这种方式。

在新建`RTCPeerConnection`时可在构造函数指定ICE服务器地址，没有指定的话则意味着这个连接只能在内网进行。

每次WebRTC找到/收集一个可用的Candidate，都会触发一次icecandidate事件，为了将收集到的Candidate交换给对端，需要给onicecandidate方法设置一个回调函数，函数里调用addIceCandidate方法来将候选者添加到通信中。

### 3. 交换Candidate

WebRTC收集好Candidate后，会通过信令系统将他们发送给对端，对端接收到这些Candidate后，会与本地的Candidate形成CandidatePair（即连接候选者对）。有了CandidatePair，WebRTC就可以开始尝试建立连接了。需要注意的是，Candidate的交换不是等所有Candidate收集好后才进行的，而是变收集变交换。

当WebRTC形成CandidatePair后，便开始尝试进行连接，一旦WebRTC发现其中一个可以连通的CandidatePair时，它就不再进行后面的连接尝试了，但发现新的Candidate时仍可以继续进行交换。

### 4. NAT是什么？

NAT：网络地址转换，它是一种解决专有网络内设备连接公网的技术。

### 5. STUN是什么？

STUN（Session Traversal Utilities for NAT，NAT会话穿越应用程序）。它允许位于NAT（或多重NAT）后的客户端找出自己对应的公网IP地址和端口，也就是俗称的“打洞”/“NAT 打洞”/“NAT 穿越”。

再直白一点，STUN服务器用于【获取计算机的公网IP地址】。

打洞的机制叫ICE，而帮忙打洞的服务器叫STUN服务。

在两个用户通信前，首先会向公网的STUN服务发送请求获取自己的公网地址，然后通过服务器各自的公网地址转发给对等端，这样双方就知道了双方的公网地址，根据这个公网地址就可以直接点对点通信了。

当STUN服务遇到对称型NAT时，就打洞失败了，这时就需要TURN服务。

### 6. TURN是什么？

TURN（Traversal USing Replays around NAT），即使用中继穿透NAT，是STUN的拓展。

如果STUN分配公网IP 的方式失败，则可以通过TURN服务器请求公网IP地址作为中继地址，将媒体数据通过TURN服务器进行中转，用作【对等连接失败的中继】，属于最终的备选方式。

目的就是【解决对称NAT无法穿越的问题】，不同于其他中继协议在于它允许客户机使用一个中继地址与多个对端同时进行通讯。完美弥补了STUN无法穿越对称型NAT的问题。

与STUN服务不同的是，TURN服务器会作为中转，转发多媒体数据会消耗大量的带宽。